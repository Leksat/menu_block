<?php
// $Id$

/**
 * Implementation of hook_perm().
 */
function menu_block_perm() {
  return array('administer menu block');
}

/**
 * Implementation of hook_menu().
 */
function menu_block_menu($may_cache) {
  $items = array();

  if ($may_cache) {
    $items[] = array(
      'path' => 'admin/build/menu-block',
      'title' => t('Menu blocks'),
      'description' => t('Enable blocks to appear on the <a href="!url">administer blocks page</a>.', array('!url' => url('admin/build/block'))),
      'access' => user_access('administer menu block'),
      'callback' => 'drupal_get_form',
      'callback arguments' => 'menu_block_settings',
    );
  }

  return $items;
}

/**
 * Display the settings form for Menu block.
 *
 * @return
 *   The form array.
 */
function menu_block_settings() {
  // The settings form is seldom used, so we store it in a separate file.
  include_once './'. drupal_get_path('module', 'menu_block') .'/menu_block.admin.inc';
  return _menu_block_settings();
}


/**
 * Implementation of hook_block().
 */
function menu_block_block($op = 'list', $delta = 'secondary', $edit = null) {
  $function = 'menu_block_block_' . $op;
  if (function_exists($function)) {
    return $function($delta);
  }
  else {
    // "op"s besides "view" are seldom used, so we store them in a separate file.
    include_once './'. drupal_get_path('module', 'menu_block') .'/menu_block.admin.inc';
    if (function_exists($function)) {
      return $function($delta, $edit);
    }
  }
}

/**
 * Returns the 'view' $op info for hook_block().
 *
 * @param $delta
 *   string The name of the block to render.
 */
function menu_block_block_view($delta) {
  $data = array();

  // Determine which menu and what level of the menu has been requested.
  list($menu, $level) = explode('-', $delta);

  // Render the block if the active menu item is in the menu.
  if (menu_in_active_trail($menu)) {

    // Get the menu items that lead to the current menu item.
    $active_trail =_menu_get_active_trail();

    // Get the menu id of the n-level link in the active trail.
    $mid = $active_trail[$level-1];

    // Use the n-level to build menu tree and block title.
    $menu_item = menu_get_item($mid);

    $data['subject'] = $menu_item['title'];
    $data['content'] = theme('menu_tree', $mid);
  }

  return $data;
}
